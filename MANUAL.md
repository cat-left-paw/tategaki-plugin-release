# MANUAL

このページは、Tategaki Plugin の使い方をまとめたガイドです。  
インストールがまだの方は、先に `INSTALL.md`、まず触ってみたい方は `QUICKSTART.md` を参照してください。

---

## できること / できないこと

### できること

#### 共通

-   縦書き/横書きの切り替え
-   フロントマターの表示（タイトルなど）
-   見出しアウトラインの表示（見出しへジャンプ）
-   テーマ機能（フォント、サイズ、行間、色などのカスタマイズと保存/切替）
-   画像の表示（標準 Markdown 画像、Obsidian の画像埋め込み）

#### 執筆モード（実験的：見たまま編集）

-   縦書きでの「見たまま編集」
-   ツールバー/右クリックメニューによる文字装飾（太字/イタリック/ハイライト/見出し など）
-   青空文庫形式のルビ（例: `｜漢字《かんじ》`）
-   検索・置換（執筆モード内）
-   「ソーステキスト編集」（Markdown 文字列を直接編集）
-   「補助入力パネル」（入力補助。重い原稿でも有効な場合があります）
-   同期バックアップ（同期前/同期後の内容を自動保存）
-   リスト項目の入れ替え（ショートカットで上下移動）

#### 参照モード（安全な編集補助）

-   Obsidian 側で編集中の Markdown を、ほぼリアルタイムに参照表示
-   表示の更新間隔を設定で調整可能

#### 書籍モード（閲覧）

-   ページ分割とページめくり（閲覧専用）
-   ルビ表示に対応
-   見出しアウトライン/見出しジャンプに対応

### できないこと / 制限

#### 執筆モード（実験的：見たまま編集）

-   本文に含まれる HTML タグ（`<...>`）は、タグの種類によっては変換できず扱えない場合があります
-   環境によっては、巨大なテキスト（特にルビ多用）の表示/編集が重くなることがあります
-   変換・同期の都合上、環境や内容によっては表示や同期が不安定になる可能性があります（大事な原稿はバックアップ推奨）

#### 参照モード（安全な編集補助）

-   参照表示のみで、Tategaki 側から Obsidian への書き戻しは行いません（編集不可）

#### 書籍モード（閲覧）

-   端末性能や文章量によっては、ページ分割に時間がかかる場合があります
-   新しいウィンドウ（独立したウィンドウ）で開いた場合、マウスホイールでのページ移動ができません（方向キー / PageUp / PageDown は利用できます）。次回以降のアップデートで修正予定です。

#### 共通

-   コミュニティプラグイン未登録のため、Obsidian 標準の自動アップデートは使えません

---

## 機能の説明

### 縦書きビューを開く

起動方法:

-   リボン（左側のアイコン）: 「縦書きビューを開く」
-   コマンドパレット: `縦書きビューを開く`

便利:

-   Obsidian の 設定 → `ホットキー` で `縦書きビューを開く` を検索し、ショートカットを割り当てると起動が楽になります

### ツールバー（執筆モード（実験的）：左から順に）

縦書きビュー上部のツールバーは、ボタンを押すだけで多くの操作ができます。  
（一部のボタンは、状況や設定によって表示されない場合があります）

-   書字方向切り替え: ボタンを押すごとに **縦書き・横書きが切り替わります**
-   元に戻す: 直前の編集を元に戻します
-   やり直す: 元に戻した変更をやり直します
-   太字: 選択範囲を太字にします
-   イタリック: 選択範囲を斜体にします
-   取り消し線: 選択範囲に取り消し線を付けます
-   下線: 選択範囲に下線を付けます
-   ハイライト: 選択範囲をハイライトします
-   見出し: 見出しレベル（H1〜H6）を選んで付けます
-   箇条書きリスト: 箇条書きリストをオン/オフします
    -   リスト項目にカーソルがあるとき、`Ctrl` / `Cmd` + 方向キーで上下に移動できます（縦書き時は `→/←`、横書き時は `↑/↓`）
-   番号付きリスト: 番号付きリストをオン/オフします
    -   リスト項目にカーソルがあるとき、`Ctrl` / `Cmd` + 方向キーで上下に移動できます（縦書き時は `→/←`、横書き時は `↑/↓`）
-   引用: 引用をオン/オフします
-   コードブロック: コードブロックをオン/オフします
-   リンク挿入: リンクを挿入/編集します
    -   リンクの挿入パネルが開きます
-   ルビ挿入: 選択した文字に対して、ルビを付加します
    -   ルビの挿入パネルが開くので、そこに追加するルビを入力します
    -   「傍点」をオンにすると、対象テキストに対して「・」のルビが追加されます
    -   すでにルビが付いている場合は、新しいルビで上書きされます
    -   ルビ入力を空のまま挿入すると、既存のルビが削除されます
-   区切り線: 区切り線を挿入します（縦書き時は「垂直の区切り線」になります）
-   書式クリア: 文字装飾をまとめて解除します
-   ルビ表示のオン/オフ: ルビの表示を切り替えます（重い原稿の対策にもなります）
-   表示設定: フォント/サイズ/色など、見た目の設定を開きます（テーマ管理もここから）
-   検索・置換: 縦書きビュー内の検索・置換パネルを開きます
-   アウトライン: 見出し一覧を表示し、クリックでその見出しへジャンプできます
-   編集ファイルを固定（ピン）: アクティブファイル追従を切り替えます  
    ピン留めすると表示中のノートを固定し、ピン解除で追従に戻ります

#### 補助入力パネル / ソーステキスト編集（重い原稿向け）

これらの機能は、長文やルビを多用した原稿などで編集が重くなったときに有効です。  
ただし「見たまま編集」としての体験は少し落ちることがあります。

##### 補助入力パネル

縦書き/横書きそれぞれで固定位置に、入力用の補助パネルを表示します。

-   入力したい位置にカーソルを置いたあと、補助入力パネルにフォーカスすると、縦書きビュー内に「擬似キャレット」が表示されます（入力位置の目安）
-   擬似キャレットが表示されていて、かつ補助入力パネルが空の状態で矢印キーを押すと、擬似キャレットの位置を移動できます  
    （縦書きのときは、期待どおりに動かない場合があります）
-   補助入力パネルで `Enter` を押すと、入力内容が擬似キャレットの位置に挿入されます  
    空の状態で `Enter` を押すと、改行を挿入します
-   複数段落をまとめて入力してから挿入することもできます  
    パネル内で改行したい場合は `Shift+Enter` を使います

##### ソーステキスト編集

段落単位で、Markdown 文字列を直接編集するモードに切り替えます。

-   編集中の段落は、一時的に装飾を外した見た目になります（編集後は通常表示に戻ります）
-   編集中に段落内で `Enter` を押すと、新しい段落が挿入されます
-   矢印キーでキャレットを動かして、段落間を移動できます
-   ルビなどが記号として表示されるため、一時的に行数が増えて、編集中の段落が隣の段落に重なって見えることがあります
-   ソーステキスト編集の段落で文字装飾（太字など）を追加すると、装飾として表示される代わりに、Markdown 記号として入力されます（例: `**太字**`）

#### ツールバー右端の状態表示:

-   同期モード: 自動同期/手動同期を示します（クリックで切り替えできます）
-   保存状態: 保存済み/未保存/保存中/エラーの状態を表示します
-   手動同期の保存: 手動同期のときは保存ボタンが表示され、`Ctrl+Shift+S` / `Cmd+Shift+S` でも実行できます

補足: このプラグインは、Obsidian 標準の編集画面とは別の画面（縦書きビュー）で文章を扱い、**変換・同期**をしながら元の Markdown ファイルへ反映します。

### 参照モードの機能（箇条書き）

-   Obsidian 側で編集中の Markdown を、ほぼリアルタイムに参照表示
-   表示の更新間隔を設定で調整可能
-   追従/ピン留めに対応（表示するファイルを切り替え/固定）
-   書き戻しなし（参照のみ。編集は Obsidian 側で行います）

### 書籍モードの機能（箇条書き）

-   ページ分割とページめくり（閲覧専用）
-   ヘッダー/フッター表示（タイトル・ページ番号など）
-   見出しアウトライン/見出しジャンプ
-   ページ遷移効果（フェード等）

### その他の機能

#### 同期バックアップ（自動バックアップ）

執筆モードでは、変換・同期の安全策として、Markdown のバックアップを自動的に作成します。

-   保存場所: `.obsidian/tategaki-sync-backups/<ファイル別フォルダ>/`
-   ファイル名: `YYYYMMDD-HHMM_<reason>__before.md` / `YYYYMMDD-HHMM_<reason>__after.md`

バックアップが作成される主なタイミング（例）:

-   手動同期
-   セッション開始時
-   一定間隔（例: 20分おき、未同期の変更がある場合）
-   大量ペーストや、ルビ/装飾など「変換リスクが高い操作」の前後

#### フロントマターの表示

ノートの先頭に YAML フロントマターがある場合、設定で表示できます（タイトルなどをビュー上部に表示します）。

表示に対応している項目（キー）は次のとおりです。

-   `title`
-   `subtitle`
-   `original_title`
-   `author`
-   `co_authors`（複数可）
-   `translator`
-   `co_translators`（複数可）

#### 画像の表示

次の形式の画像を表示できます。

-   標準 Markdown 画像: `![alt](path)`
-   Obsidian の画像埋め込み: `![[image.png]]`

---

## 設定項目の説明

設定画面: Obsidian の 設定 → `コミュニティプラグイン` → `Tategaki Plugin`

### 縦書きビュー関連

-   `ビュー起動時にモード選択を表示`  
    縦書きビューを開くときに、執筆/参照/書籍のモード選択を表示します。オフの場合は、直近に使用したモードで開きます。

-   `アクティブファイルを追従する`  
    オンにすると、Obsidian でアクティブにしたファイルが自動的に縦書きビューに表示されます。

-   `フロントマターを表示`  
    YAML フロントマターの title/subtitle などをビュー上部に表示します（デフォルトは非表示）。

-   `外部同期の更新間隔(ms)`  
    追従やカーソル同期の確認間隔です。0 に近いほど追従が速い一方、環境によっては負荷が増えることがあります。

-   `同期モード`  
    自動同期/手動同期を切り替えます。大事な原稿は手動同期が安心です。

-   `アプリ終了時の未保存変更`  
    未保存の変更がある場合、終了時に「保存して終了」か「破棄して終了」かを選びます。

-   `カーソル同期`  
    Obsidian 標準エディタ側のカーソル位置を縦書きビューにも反映します。

### アップデートとサポート

-   `手動でアップデートを確認`  
    ボタンを押したときだけ通信して、最新版があるかを確認します。

-   `同期バックアップをゴミ箱へ移動`  
    同期の安全策として作成されたバックアップをまとめてゴミ箱へ移動します（復元できなくなるので注意）。

-   `サポート（寄付）`  
    寄付リンクを開きます（任意）。

### テーマ管理

-   現在のテーマ表示
-   保存されているテーマ一覧（スクロール）
-   テーマの保存/切替/削除

## 表示設定（ツールバーから開く）

縦書きビューのツールバーにある「表示設定」（歯車アイコン）から、表示や動作をまとめて調整できます。  
変更は基本的にその場で反映され、以後も設定として保存されます。

主な項目は次のとおりです（名称は画面の表示に合わせています）。

### 基本

-   `同期モード`  
    自動保存/手動保存を切り替えます。手動保存の場合は、ツールバーの保存ボタン（または `Ctrl+Shift+S` / `Cmd+Shift+S`）で反映します。
-   `アプリ終了時の未保存変更`  
    未保存の変更がある場合に、終了時に「保存して終了」か「破棄して終了」かを選びます。
-   `書字方向`  
    縦書き/横書きを選択します（ツールバーの書字方向ボタンでも切り替えできます）。

**重要（アプリ終了時の挙動）**

- 未保存の状態で「タブを閉じる」「別のノートへ切り替える」などを行うと、警告が表示されます
- ただし **Obsidian アプリ自体を終了する場合は、警告なしに終了します（仕様）**
- アプリ終了時に未保存の変更を「保存する / 破棄する」は、上記の `アプリ終了時の未保存変更` で選べます

### 文字（本文）

-   `フォント`  
    ゴシック体/明朝体の選択、またはカスタムフォントを追加して選べます（カスタムフォントの並び替え/削除も可能です）。
-   `フォントサイズ`  
    本文の文字サイズを調整します。
-   `行間`  
    行の間隔を調整します。
-   `文字間`  
    文字の間隔を調整します（0 が標準）。

#### カスタムフォントの追加方法

1. 縦書きビューのツールバーから「表示設定」（歯車アイコン）を開きます
2. `フォント` の項目で、下のほうにある「カスタムフォント」欄にフォント名を入力します
3. `追加` を押します
4. 追加したフォントを選ぶと反映されます

※カスタムフォントは「フォント名の文字列」を登録するだけです。OS にそのフォントがインストールされていない場合は反映されません。

### ルビ

-   `ルビ表示`  
    オフにするとルビタグを生成せず、青空記法（`｜本文《よみ》`）のまま表示します。重い原稿の対策にもなります。
-   `ルビサイズ`  
    ルビ（ふりがな）の大きさを調整します。
-   `ルビ位置`  
    ルビを本文に近づける/離すなど、位置関係を調整します（縦書き/横書きで見え方が変わります）。

### ページ表示

-   `ページ枠の表示`  
    ページ枠を表示するか、しないかを選びます。

### 色設定

-   `文字色` / `ページ色` / `背景色`  
    本文、ページ、ページ外側の色を調整します。

### 見出し

-   `見出しフォント`  
    見出し専用のフォントを選べます（本文と同じ/ゴシック体/明朝体/カスタム）。
-   `見出し文字色` / `見出し文字色をリセット`  
    見出しの文字色を調整、または本文と同じ色に戻します。

### プレビュー設定

-   `フロントマター情報を表示`  
    YAML 自体ではなく、次の項目を本文先頭に表示します: `title` / `subtitle` / `original_title` / `author` / `co_authors` / `translator` / `co_translators`

### 書籍モード

-   `ヘッダーの内容` / `ヘッダーの配置`  
    ヘッダーに表示する内容（なし/タイトルなど）と、表示位置（左/中央/右）を選びます。
-   `フッターの内容` / `フッターの配置`  
    フッターに表示する内容（なし/ページ番号など）と、表示位置（左/中央/右）を選びます。
-   `ページ番号の形式`  
    `現在ページ` / `現在ページ/総ページ数` の形式を選びます。
-   `ページ遷移効果`  
    ページ移動時の視覚効果（なし/フェード/スライドなど）を選びます。

### テーマ

表示設定で調整した内容は、テーマとして保存できます。

-   テーマの選択/再適用/削除
-   `現在の設定をテーマとして保存`

---

## 困ったときは

-   不安な場合は「手動同期」を使ってください
-   編集前に Markdown ファイルを複製するのも有効です
-   問題が起きた場合はバックアップフォルダ（`.obsidian/tategaki-sync-backups/`）を確認してください
-   参照モードを使用して編集すると、同期・変換に伴うリスクがほぼ無くなります（編集は Obsidian 側で行います）

---

## よくある質問（FAQ）

### Q.（共通）縦書きビューが開けません

A. 次を確認してください。

-   プラグインが有効になっているか（設定 → コミュニティプラグイン）
-   「セーフモード（制限モード）」がオフになっているか
-   コマンドパレットに `縦書きビューを開く` が出るか

### Q.（執筆モード）編集したのに元のノートに反映されません

A. 「同期モード」が手動同期になっている可能性があります。手動同期の場合は、ツールバーの保存ボタンまたは `Ctrl+Shift+S` / `Cmd+Shift+S` で反映してください。

### Q.（執筆モード）重くて編集がつらいです

A. 次を試してください。

-   ルビ表示をオフにする
-   「ソーステキスト編集」を使う
-   ノートを章ごとに分割する

### Q.（参照モード）参照モードで編集できません

A. 仕様です。参照モードは書き戻しを行いません。編集は Obsidian 標準エディタ側で行ってください（必要なら執筆モードに切り替えます）。

### Q.（参照モード）表示の更新が遅い/追従しない気がします

A. 設定の `外部同期の更新間隔(ms)` を調整してください。また、ピン留め中は追従しません（ピンを解除してください）。

### Q.（書籍モード）ページ分割に時間がかかります

A. 端末性能や文章量によっては時間がかかります。長文では、章ごとに分割するか、参照モードで編集/確認しつつ書籍モードは閲覧時に使う運用がおすすめです。

---

## トラブルシューティング

### （執筆モード）変換や同期がうまくいかない / 内容が崩れた

1. いったん同期を止めて、バックアップから復元を検討してください
2. コマンド `直前の同期バックアップを開く/復元` を実行します

同期バックアップの保存場所:

-   `.obsidian/tategaki-sync-backups/`

### （執筆モード）本文に HTML タグが含まれていて扱えない

HTML タグを「文章として」含めたい場合は、コードブロックに入れてください。

```text
<div>これはタグではなく文字として見せたい</div>
```

### （執筆モード）バックアップを消したい

設定画面（またはコマンド）から「同期バックアップをゴミ箱へ移動」を実行してください。  
手動で消す場合は `.obsidian/tategaki-sync-backups/` を削除します。
