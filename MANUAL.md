# MANUAL

このページは、Obsidian用縦書き編集プラグイン「Tategaki」の使い方をまとめたガイドです。
インストールがまだの方は、先に `INSTALL.md`、まず触ってみたい方は `QUICKSTART.md` を参照してください。

## v1.2.x の主な変更点（直近）

- **（新）執筆・参照モードを追加**: Obsidian の Markdown を直接編集する新方式により、従来の変換・同期リスクがありません
- **参照表示の統合**: ペアのノートをアクティブにすると、（新）執筆・参照モードのビューが参照表示として追従します
- **ペアノート方式**: Obsidian のノートと縦書きビューが連動します
- **互換モード**: v1.1.1以前の執筆モード（TipTap版）は「互換モード」として引き続き利用できます（設定で有効化が必要／当面維持）
- **選択/IMEの安定化**: SoT + Overlay IME + Native選択補助の挙動を見直し、右クリックやオートスクロール時の選択維持を改善
- **チェックリストボタンを追加（SoT）**: ツールバーから `- [ ]` / `- [x]` の切り替えが可能
- **Overlay IME を改良**: 見出しや太字など装飾済みテキストを編集する際、入力中テキストが元の装飾スタイルに追従
- **縦中横（TCY）を拡張**: 明示指定用の独自記法 `｟...｠` と、表示時のみ適用する自動TCY（英数字2〜4文字 + `!!` / `!?` / `??`）を使い分け可能
- **書籍モードの余白設定を拡張**: 上余白/下余白を表示設定から調整可能
- **モバイル編集の安全側調整**: モバイル編集時は右クリックメニューを表示しない仕様に変更
- **配布形式の整理**: v1.2.0 以降はインストーラースクリプト同梱を廃止し、Zip配布はプラグイン本体中心に統一

---

## できること / できないこと

### できること

#### 共通

- 縦書き/横書きの切り替え
- フロントマターの表示（タイトルなど）
- テーマ機能（フォント、サイズ、行間、色などのカスタマイズと保存/切替）
- ツールバーから設定を手軽に調整（フォント、余白など）
- 画像の表示（標準 Markdown 画像、Obsidian の画像埋め込み）

#### （新）執筆・参照モード

- **Obsidian の Markdown を直接編集する新方式**（変換・同期処理が不要）
- 縦書きでの「見たまま編集」
- **ペアノート方式**：Obsidian のノートと縦書きビューが連動
- **参照表示の統合**：ペアのノートをアクティブにすると参照表示に切り替わり
- ツールバー/右クリックメニューによる文字装飾（太字/イタリック/ハイライト/見出し など）
- 青空文庫形式のルビ（例: `｜漢字《かんじ》`）
- **見出しの折りたたみ**：見出しをクリックして折りたたみ/展開
- **見出し（アウトライン）ジャンプ**：ツールバーのアウトラインボタンから見出しを選択してジャンプ
- リスト項目の入れ替え（ショートカットで上下移動）
- 同期バックアップ不要（同期リスクなし）

#### （新）執筆・参照モードの参照表示

- Obsidian 側で編集中の Markdown を、リアルタイムに参照表示
- （新）執筆・参照モードのビュー内で自動的に切り替わります（編集は Obsidian 側で実施）

#### 互換モード（TipTap版）

- v1.1.1以前の執筆モード（変換・同期あり）
- 設定で互換モードを有効化する必要があります
- 検索・置換機能
- 「ソーステキスト編集」（Markdown 文字列を直接編集）
- 「補助入力パネル」（入力補助。重い原稿でも有効な場合があります）
- 同期バックアップ（同期前/同期後の内容を自動保存）
- **注意**：当面は維持します

### できないこと / 制限

#### （新）執筆・参照モード

- **ペアノート**：対（ペア）になる Obsidian のノートを開いておく必要があります
    - ペアのノートを閉じると、縦書きビューも自動的に閉じられます
- `<font>` や `<ruby>` などの HTML タグは、そのままプレーンテキストとして表示されます
- HTML タグを使った装飾は反映されません（HTML タグはプレーンテキストとしてそのまま表示されます　青空文庫形式のルビは正常に表示されます）

#### 互換モード（TipTap版）

- 本文に含まれる HTML タグ（`<...>`）は、タグの種類によっては変換できず扱えない場合があります
- 環境によっては、巨大なテキスト（特にルビ多用）の表示/編集が重くなることがあります
- 変換・同期の都合上、環境や内容によっては表示や同期が不安定になる可能性があります（大事な原稿はバックアップ推奨）
- 同期時や、大きな変更の際にバックアップファイルが作られます。`.obsidian/tategaki-sync-backups/<ファイル別フォルダ>/`

#### 共通

- コミュニティプラグイン申請中（審査中）のため、Obsidian 標準の自動アップデートはまだ使えません
- 本プラグインはデスクトップ専用です（モバイルはサポート対象外）

---

## 機能の説明

### 縦書きビューを開く

起動方法:

- リボン（左側のアイコン）: 「縦書きビューを開く」
- コマンドパレット: `縦書きビューを開く`
  起動時にモード選択ダイアログが出ます

便利:

- Obsidian の 設定 → `ホットキー` で `縦書きビューを開く` を検索し、ショートカットを割り当てると起動が楽になります

### （新）執筆・参照モード

#### ペアノートについて

（新）執筆・参照モードでは、縦書きビューと Obsidian のノート（ペアノート）が連動します。

- ペアノートのタブにはアイコンが表示されます
- ペアノートを閉じると、縦書きビューも自動的に閉じられます
- ペアノートをアクティブにすると、参照表示に切り替わります
- 縦書きビューをクリックすると、執筆状態に戻ります

#### ツールバー（（新）執筆・参照モード：左から順に）

縦書きビュー上部のツールバーは、ボタンを押すだけで多くの操作ができます。
（一部のボタンは、状況や設定によって表示されない場合があります）

- **書字方向切り替え**: ボタンを押すごとに **縦書き・横書きが切り替わります**
- **ファイル切替**: （新）執筆・参照モードで開くノートを切り替えます（最近開いたノートから選べます）
- **書籍モードへ移動**: 書籍モード（閲覧専用）を開きます。もう一度押すと書籍モードを閉じます
- **元に戻す**: 直前の編集を元に戻します（Obsidian の Undo と連動）
- **やり直す**: 元に戻した変更をやり直します（Obsidian の Redo と連動）
- **太字**: 選択範囲を太字にします
- **イタリック**: 選択範囲を斜体にします
- **取り消し線**: 選択範囲に取り消し線を付けます
- **下線**: 選択範囲に下線を付けます
- **ハイライト**: 選択範囲をハイライトします
- **インラインコード（（新）執筆・参照モードのみ）**: 選択範囲を `` `コード` `` の形にします
- **見出し**: 見出しレベル（H1〜H6）を選んで付けます
- **箇条書きリスト**: 箇条書きリストをオン/オフします
    - リスト項目にカーソルがあるとき、`Ctrl` / `Cmd` + 方向キーで上下に移動できます（縦書き時は `→/←`、横書き時は `↑/↓`）
- **チェックリスト（SoT）**: チェックリストをオン/オフします（`- [ ]` / `- [x]`）
- **番号付きリスト**: 番号付きリストをオン/オフします
    - リスト項目にカーソルがあるとき、`Ctrl` / `Cmd` + 方向キーで上下に移動できます（縦書き時は `→/←`、横書き時は `↑/↓`）
- **引用**: 引用をオン/オフします
- **コードブロック**: コードブロックをオン/オフします
- **リンク挿入**: リンクを挿入/編集します
- **ルビ挿入**: 選択した文字に対して、ルビを付加します（青空文庫形式）
- **縦中横（TCY）**: 選択範囲を独自記法 `｟...｠` で包んでTCY化します（再実行で解除）
- **区切り線**: 区切り線を挿入します（縦書き時は「垂直の区切り線」になります）
- **書式クリア**: 文字装飾をまとめて解除します
- **ルビ表示のオン/オフ**: ルビの表示を切り替えます
- **ソーステキスト編集**: いま操作している段落を、Markdown の文字（`**` や `[]()` など）で直接編集できるモードに切り替えます（もう一度押すと通常表示に戻ります）
- **CE補助(IME)**（（新）執筆・参照モードのみ）: 入力やカーソル移動がうまくいかないときの補助モードです。オンにすると IME 入力が安定する場合があります（もう一度押すとオフになります）。装飾済みテキスト（見出し/太字など）を編集するときは、入力中テキストの見た目も可能な範囲で追従します
- **表示設定**: フォント/サイズ/余白など、見た目の設定を開きます（テーマ管理もここから）
- **アウトライン**: 見出し一覧を表示し、クリックでその見出しへジャンプできます

#### 見出しの折りたたみ

見出しをクリックすると、その見出しの内容を折りたたみ/展開できます。

- 折りたたまれた見出しは、アイコンで表示されます
- もう一度クリックすると展開されます

#### 参照表示との統合

（新）執筆・参照モードのビュー内で、Obsidian のノート（ペアノート）をアクティブにすると、参照表示（縦書きビューを確認しながら Obsidian のノートを編集する状態）に切り替わります。

- ペアノートをクリックすると参照表示に
- 縦書きビューをクリックすると執筆状態に

### 互換モード（TipTap版）

v1.1.1以前の執筆モード（変換・同期あり）を「互換モード」として引き続き利用できます。
利用するには、設定で互換モードを有効化してください。

#### ツールバー

基本的な機能は（新）執筆・参照モードと同様ですが、以下の追加機能があります：

- **検索・置換**: 縦書きビュー内の検索・置換パネルを開きます
- **同期モード**: 自動同期/手動同期を示します（クリックで切り替えできます）
- **保存状態**: 保存済み/未保存/保存中/エラーの状態を表示します
- **手動同期の保存**: 手動同期のときは保存ボタンが表示され、`Ctrl+Shift+S` / `Cmd+Shift+S` でも実行できます

#### 補助入力パネル / ソーステキスト編集（互換モード：重い原稿向け）

これらの機能は、互換モードで長文やルビを多用した原稿などで編集が重くなったときに有効です。

##### 補助入力パネル

縦書き/横書きそれぞれで固定位置に、入力用の補助パネルを表示します。

- 入力したい位置にカーソルを置いたあと、補助入力パネルにフォーカスすると、縦書きビュー内に「擬似キャレット」が表示されます（入力位置の目安）
- 擬似キャレットが表示されていて、かつ補助入力パネルが空の状態で矢印キーを押すと、擬似キャレットの位置を移動できます
- 補助入力パネルで `Enter` を押すと、入力内容が擬似キャレットの位置に挿入されます
- 複数段落をまとめて入力してから挿入することもできます（パネル内で改行したい場合は `Shift+Enter` を使います）

##### ソーステキスト編集

段落単位で、Markdown 文字列を直接編集するモードに切り替えます。

- 編集中の段落は、一時的に装飾を外した見た目になります（編集後は通常表示に戻ります）
- 編集中に段落内で `Enter` を押すと、新しい段落が挿入されます
- 矢印キーでキャレットを動かして、段落間を移動できます
- ルビなどが記号として表示されるため、一時的に行数が増えて、編集中の段落が隣の段落に重なって見えることがあります
- ソーステキスト編集の段落で文字装飾（太字など）を追加すると、Markdown 記号として入力されます（例: `**太字**`）

**注意**: 互換モード（TipTap版）は当面維持します。（新）執筆・参照モードと用途に応じて使い分けてください。

### （新）執筆・参照モードの参照表示

（新）執筆・参照モードでは、参照表示が執筆状態に統合されています。

- Obsidian 側で編集中の Markdown を、リアルタイムに参照表示
- 書き戻しなし（参照のみ。編集は Obsidian 側で行います）
- **自動切り替え**: ペアノートをアクティブにすると、参照表示に切り替わります
- 縦書きビューをクリックすると、執筆状態に戻ります

### 書籍モードの機能（箇条書き）

- ページ分割とページめくり（閲覧専用）
- ヘッダー/フッター表示（タイトル・ページ番号など）
- 見出しアウトライン/見出しジャンプ
- ページ遷移効果（フェード等）

### その他の機能

#### 同期バックアップ（互換モード）

互換モード（旧TipTap版）では、変換・同期の安全策として、Markdown のバックアップを自動的に作成します（設定でOFFにできます）。

- 保存場所: `.obsidian/tategaki-sync-backups/<ファイル別フォルダ>/`
- ファイル名: `YYYYMMDD-HHMM_<reason>__before.md` / `YYYYMMDD-HHMM_<reason>__after.md`

バックアップが作成される主なタイミング（例）:

- 手動同期
- セッション開始時
- 一定間隔（例: 20分おき、未同期の変更がある場合）
- 大量ペーストや、ルビ/装飾など「変換リスクが高い操作」の前後

**注意**: （新）執筆・参照モードでは、同期バックアップは不要です（同期リスクがないため）。

バックアップをOFFにする場合は、Obsidian の「Open version history」（ファイル右クリック）で復元できることを確認してください。

#### フロントマターの表示

ノートの先頭に YAML フロントマターがある場合、設定で表示できます（タイトルなどをビュー上部に表示します）。

表示に対応している項目（キー）は次のとおりです。

- `title`
- `subtitle`
- `original_title`
- `author`
- `co_authors`（複数可）
- `translator`
- `co_translators`（複数可）

#### 画像の表示

次の形式の画像を表示できます。

- 標準 Markdown 画像: `![alt](path)`
- Obsidian の画像埋め込み: `![[image.png]]`

---

## 設定項目の説明

設定画面: Obsidian の 設定 → `コミュニティプラグイン` → `Tategaki Plugin`

### 縦書きビュー関連

見た目や表示に関する項目は、後述の「表示設定（ツールバー）」にまとめています。

#### 互換モード（旧TipTap版）のみ

- `外部同期の更新間隔(ms)`
  追従やカーソル同期の確認間隔です。0 に近いほど追従が速い一方、環境によっては負荷が増えることがあります。

- `同期モード`
  自動同期/手動同期を切り替えます。大事な原稿は手動同期が安心です。

- `同期バックアップを作成`
  互換モードの同期時にバックアップを作成します。OFFにするとバックアップは作成されません。
  OFF時は、Obsidian の「Open version history」を利用して復元してください。

- `同期バックアップフォルダを開く`
  バックアップ保存先（`.obsidian/tategaki-sync-backups/`）を開きます。

- `同期バックアップをゴミ箱へ移動`
  互換モードの同期で作成されたバックアップをまとめてゴミ箱へ移動します（復元できなくなるので注意）。

- `アプリ終了時の未保存変更`
  未保存の変更がある場合、終了時に「保存して終了」か「破棄して終了」かを選びます。

- `カーソル同期`
  Obsidian 標準エディタ側のカーソル位置を縦書きビューにも反映します。

**重要（互換モードのアプリ終了時の挙動）**

- 未保存の状態で「タブを閉じる」「別のノートへ切り替える」などを行うと、警告が表示されます
- ただし **Obsidian アプリ自体を終了する場合は、警告なしに終了します（仕様）**
- アプリ終了時に未保存の変更を「保存する / 破棄する」は、上記の `アプリ終了時の未保存変更` で選べます

### アップデートとサポート

- `手動でアップデートを確認`
  ボタンを押したときだけ通信して、最新版があるかを確認します。

- `サポート（寄付）`
  寄付リンクを開きます（任意）。

### テーマ管理

- 現在のテーマ表示
- 保存されているテーマ一覧（スクロール）
- テーマの保存/切替/削除

## 表示設定（ツールバーから開く）

縦書きビューのツールバーにある「表示設定」（歯車アイコン）から、表示や動作をまとめて調整できます。  
変更は基本的にその場で反映され、以後も設定として保存されます。

主な項目は次のとおりです（名称は画面の表示に合わせています）。

### 基本

- `書字方向`
  縦書き/横書きを選択します（ツールバーの書字方向ボタンでも切り替えできます）。

### 文字（本文）

- `フォント`  
  ゴシック体/明朝体の選択、またはカスタムフォントを追加して選べます（カスタムフォントの並び替え/削除も可能です）。
- `フォントサイズ`  
  本文の文字サイズを調整します。
- `行間`  
  行の間隔を調整します。
- `文字間`  
  文字の間隔を調整します（0 が標準）。

#### カスタムフォントの追加方法

1. 縦書きビューのツールバーから「表示設定」（歯車アイコン）を開きます
2. `フォント` の項目で、下のほうにある「カスタムフォント」欄にフォント名を入力します
3. `追加` を押します

### 同期バックアップ（互換モードのみ）

互換モードの表示設定には、同期バックアップのON/OFFと、バックアップフォルダ操作が含まれます。
バックアップをOFFにする場合は、Obsidian の「Open version history」を利用して復元できることを確認してください。
4. 追加したフォントを選ぶと反映されます

※カスタムフォントは「フォント名の文字列」を登録するだけです。OS にそのフォントがインストールされていない場合は反映されません。

### ルビ

- `ルビ表示`  
  オフにするとルビタグを生成せず、青空記法（`｜本文《よみ》`）のまま表示します。重い原稿の対策にもなります。
- `ルビサイズ`  
  ルビ（ふりがな）の大きさを調整します。
- `ルビ位置`  
  ルビを本文に近づける/離すなど、位置関係を調整します（縦書き/横書きで見え方が変わります）。

### 縦中横（TCY）

- `縦中横`  
  ツールバー/右クリックメニューから、選択範囲に明示TCYを適用できます。適用時は独自記法 `｟...｠` が本文に入ります。
- `自動縦中横`  
  英数字2〜4文字と `!!` / `!?` / `??` を「表示時のみ」TCY化します。本文に記号は追加しません。

使い分けの目安:

- 明示TCY（`｟...｠`）: 「この箇所だけ必ずTCYにしたい」とき
- 自動TCY: 記号を増やさず、一般的な短い英数字/記号だけを読みやすくしたいとき

注意:

- `｟...｠` はこのプラグインの独自記法です。未対応環境では記号がそのまま見える場合があります。

### IME表示の補正

IME（日本語変換）の候補ウィンドウがずれる場合に、表示位置を微調整します。

- `横書き: 上方向補正`
  横書きIMEの表示位置を、上方向(+) / 下方向(-)に調整します（em単位）。
- `縦書き: 右方向補正`
  縦書きIMEの表示位置を、右方向(+) / 左方向(-)に調整します（em単位）。

### キャレット設定

キャレット（文字入力位置の棒）の見た目を調整します。

- `キャレットの色`
  文字色 / ハイライト色 / カスタム色 から選べます。
- `キャレットのカスタム色`
  「カスタム色」を選んだときの色です。
- `キャレットの幅`
  キャレットの太さを調整します（px）。※互換モードや CE補助(IME) 中は反映されません。
- `CE補助モードでネイティブキャレットを使用`
  CE補助(IME) をオンにしたとき、OS標準のキャレットを使うかどうかを選べます。

### ページ表示

- `ページ枠の表示`
  ページ枠を表示するか、しないかを選びます。

#### （新）執筆・参照モード / 互換モード共通

- `余白設定`
    - `上余白`: ページ上部の余白を調整します（0〜200px）
    - `下余白`: ページ下部の余白を調整します（0〜200px）
    - 縦書き表示時にスクロールせず固定で表示される上下の余白を設定できます

### 色設定

- `文字色` / `ページ色` / `背景色`  
  本文、ページ、ページ外側の色を調整します。

### 見出し

- `見出しフォント`  
  見出し専用のフォントを選べます（本文と同じ/ゴシック体/明朝体/カスタム）。
- `見出し文字色` / `見出し文字色をリセット`  
  見出しの文字色を調整、または本文と同じ色に戻します。

### プレビュー設定

- `フロントマター情報を表示`  
  YAML 自体ではなく、次の項目を本文先頭に表示します: `title` / `subtitle` / `original_title` / `author` / `co_authors` / `translator` / `co_translators`

### 書籍モード

- `ヘッダーの内容` / `ヘッダーの配置`  
  ヘッダーに表示する内容（なし/タイトルなど）と、表示位置（左/中央/右）を選びます。
- `フッターの内容` / `フッターの配置`  
  フッターに表示する内容（なし/ページ番号など）と、表示位置（左/中央/右）を選びます。
- `ページ番号の形式`  
  `現在ページ` / `現在ページ/総ページ数` の形式を選びます。
- `ページ遷移効果`  
  ページ移動時の視覚効果（なし/フェード/スライドなど）を選びます。

### テーマ

表示設定で調整した内容は、テーマとして保存できます。

- テーマの選択/再適用/削除
- `現在の設定をテーマとして保存`

---

## 困ったときは

### （新）執筆・参照モード

- **同期リスクなし**: （新）執筆・参照モードは Obsidian の Markdown を直接編集するため、同期リスクはありません
- 編集は即座に Obsidian のノートに反映されます
- ペアノートを閉じると縦書きビューも自動的に閉じられます

### 互換モード（旧TipTap版）

- 不安な場合は「手動同期」を使ってください
- 編集前に Markdown ファイルを複製するのも有効です
- 問題が起きた場合はバックアップフォルダ（`.obsidian/tategaki-sync-backups/`）を確認してください
- **注意**: 互換モード（TipTap版）は当面維持します。（新）執筆・参照モードと用途に応じて使い分けてください

---

## よくある質問（FAQ）

### Q.（共通）縦書きビューが開けません

A. 次を確認してください。

- プラグインが有効になっているか（設定 → コミュニティプラグイン）
- 「セーフモード（制限モード）」がオフになっているか
- コマンドパレットに `縦書きビューを開く` が出るか

### Q.（（新）執筆・参照モード）編集したのに元のノートに反映されません

A. （新）執筆・参照モードでは、編集は即座に Obsidian のノートに反映されます。互換モード（旧TipTap版）を使用している場合は、「同期モード」が手動同期になっている可能性があります。手動同期の場合は、ツールバーの保存ボタンまたは `Ctrl+Shift+S` / `Cmd+Shift+S` で反映してください。

### Q.（互換モード）重くて編集がつらいです

A. 互換モード（旧TipTap版）で次を試してください。

- ルビ表示をオフにする
- 「ソーステキスト編集」を使う
- 「補助入力パネル」を使う

または、（新）執筆・参照モードの使用をおすすめします（軽量化されています）。

- ノートを章ごとに分割する

### Q.（参照表示）参照表示で編集できません

A. 仕様です。参照表示は書き戻しを行いません。編集は Obsidian 標準エディタ側で行ってください（必要なら（新）執筆・参照モードの執筆状態に切り替えます）。

### Q.（互換モード）表示の更新が遅い/追従しない気がします

A. 設定の `外部同期の更新間隔(ms)` を調整してください（互換モード専用の設定です）。

### Q.（書籍モード）ページ分割に時間がかかります

A. 端末性能や文章量によっては時間がかかります。長文では、章ごとに分割するか、（新）執筆・参照モードの参照表示で編集/確認しつつ書籍モードは閲覧時に使う運用がおすすめです。

### Q. TCYの `｟...｠` が他エディタでそのまま見えます

A. 仕様です。`｟...｠` は明示TCYの独自記法です。記号を本文に残したくない場合は、表示設定の `自動縦中横` を使ってください（英数字2〜4文字 + `!!` / `!?` / `??` を表示時のみTCY化）。

---

## トラブルシューティング

### （互換モード）変換や同期がうまくいかない / 内容が崩れた

1. いったん同期を止めて、バックアップから復元を検討してください
2. 同期バックアップフォルダ（`.obsidian/tategaki-sync-backups/`）から必要なファイルを復元します  
   ※バックアップをOFFにしている場合は、Obsidian の「Open version history」を利用してください

同期バックアップの保存場所:

- `.obsidian/tategaki-sync-backups/`

### （互換モード）本文に HTML タグが含まれていて扱えない

HTML タグを「文章として」含めたい場合は、コードブロックに入れてください。

```text
<div>これはタグではなく文字として見せたい</div>
```

### （互換モード）バックアップを消したい

設定画面から「同期バックアップをゴミ箱へ移動」を実行してください。  
必要なファイルだけ残したい場合は「同期バックアップフォルダを開く」から整理できます。  
手動で消す場合は `.obsidian/tategaki-sync-backups/` を削除します。
